<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Admin | AgendaBarber</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen">

<!-- Header -->
<header class="bg-slate-900 border-b border-slate-800 px-8 py-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">Agenda<span class="text-green-500">Barber</span></h1>
  <div class="flex gap-4 items-center">
    <span id="userName" class="text-gray-300"></span>
    <span id="barbeariaName" class="text-gray-400 text-sm"></span>
    <button id="btnLogout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-semibold">
      Sair
    </button>
  </div>
</header>

<div class="max-w-7xl mx-auto px-6 py-8">
  <!-- Se√ß√£o de Configura√ß√£o Inicial (quando n√£o tem barbearia) -->
  <div id="configuracaoInicial" class="hidden">
    <div class="max-w-2xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-center">Configure sua Barbearia</h2>
      <p class="text-gray-400 mb-8 text-center">Voc√™ precisa criar ou associar sua barbearia para continuar</p>
      
      <div class="bg-slate-900 p-8 rounded-xl border border-slate-800">
        <!-- Op√ß√£o 1: Criar Nova Barbearia -->
        <div class="mb-8">
          <h3 class="text-xl font-bold mb-4">Criar Nova Barbearia</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Nome da Barbearia</label>
              <input id="inputNomeBarbearia" type="text" 
                class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
                placeholder="Ex: Barbearia do Jo√£o">
            </div>
            <button id="btnCriarBarbearia" 
              class="w-full bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-lg font-semibold">
              Criar Barbearia
            </button>
          </div>
        </div>
        
        <div class="border-t border-slate-800 pt-8">
          <h3 class="text-xl font-bold mb-4">OU Associar a uma Barbearia Existente</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Selecione uma Barbearia</label>
              <select id="selectBarbeariaExistente" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700">
                <option value="">Carregando barbearias...</option>
              </select>
            </div>
            <button id="btnAssociarBarbearia" 
              class="w-full bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold">
              Associar Barbearia
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Principal (quando tem barbearia) -->
  <div id="dashboardPrincipal" class="hidden">
  <h2 class="text-3xl font-bold mb-6">Dashboard da Barbearia</h2>

  <!-- Estat√≠sticas -->
  <div class="grid md:grid-cols-4 gap-4 mb-6">
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <div class="text-3xl font-bold text-green-400" id="statAgendamentos">0</div>
      <div class="text-sm text-gray-400 mt-1">Agendamentos Hoje</div>
    </div>
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <div class="text-3xl font-bold text-blue-400" id="statBarbeiros">0</div>
      <div class="text-sm text-gray-400 mt-1">Barbeiros</div>
    </div>
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <div class="text-3xl font-bold text-purple-400" id="statServicos">0</div>
      <div class="text-sm text-gray-400 mt-1">Servi√ßos</div>
    </div>
    <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
      <div class="text-3xl font-bold text-yellow-400" id="statPendentes">0</div>
      <div class="text-sm text-gray-400 mt-1">Pendentes</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="border-b border-slate-800 mb-6">
    <div class="flex gap-4">
      <button id="tabAgendamentos" class="tab-btn active px-4 py-2 border-b-2 border-green-500 font-semibold">
        Agendamentos
      </button>
      <button id="tabServicos" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-slate-700 font-semibold">
        Servi√ßos
      </button>
      <button id="tabBarbeiros" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-slate-700 font-semibold">
        Barbeiros
      </button>
    </div>
  </div>

  <!-- Conte√∫do: Agendamentos -->
  <div id="conteudoAgendamentos" class="tab-content">
    <!-- Filtros -->
    <div class="bg-slate-900 p-4 rounded-xl mb-6 border border-slate-800">
      <div class="flex gap-4 items-center flex-wrap">
        <div>
          <label class="block text-sm font-medium mb-2">Filtrar por data</label>
          <input id="filtroData" type="date" class="p-2 bg-slate-800 rounded-lg border border-slate-700">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Filtrar por status</label>
          <select id="filtroStatus" class="p-2 bg-slate-800 rounded-lg border border-slate-700">
            <option value="">Todos</option>
            <option value="pendente">Pendente</option>
            <option value="confirmado">Confirmado</option>
            <option value="concluido">Conclu√≠do</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btnLimparFiltros" 
            class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Limpar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Lista de Agendamentos -->
    <div id="listaAgendamentos" class="space-y-4">
      <!-- Agendamentos ser√£o inseridos aqui -->
    </div>

    <div id="mensagemVaziaAgendamentos" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg">Nenhum agendamento encontrado.</p>
    </div>
  </div>

  <!-- Conte√∫do: Servi√ßos -->
  <div id="conteudoServicos" class="tab-content hidden">
    <!-- Bot√£o para novo servi√ßo -->
    <button id="btnNovoServico" 
      class="mb-6 bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-lg font-semibold">
      + Novo Servi√ßo
    </button>

    <!-- Formul√°rio de Servi√ßo (oculto inicialmente) -->
    <div id="formServico" class="hidden bg-slate-900 p-6 rounded-xl mb-6 border border-slate-800">
      <h3 class="text-xl font-bold mb-4" id="formTitleServico">Novo Servi√ßo</h3>
      
      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2">Nome do Servi√ßo</label>
          <input id="inputNomeServico" type="text" 
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="Ex: Corte de Cabelo">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Dura√ß√£o (minutos)</label>
          <input id="inputDuracaoServico" type="number" 
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="30" min="1">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Pre√ßo (R$)</label>
          <input id="inputPrecoServico" type="number" step="0.01"
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="50.00" min="0">
        </div>
      </div>
      
      <div class="flex gap-3">
        <button id="btnSalvarServico" 
          class="bg-green-500 hover:bg-green-600 text-black px-6 py-2 rounded-lg font-semibold">
          Salvar
        </button>
        <button id="btnCancelarFormServico" 
          class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold">
          Cancelar
        </button>
      </div>
    </div>

    <!-- Lista de Servi√ßos -->
    <div id="listaServicos" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Servi√ßos ser√£o inseridos aqui -->
    </div>

    <div id="mensagemVaziaServicos" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg">Nenhum servi√ßo cadastrado.</p>
      <p class="text-sm mt-2">Clique em "Novo Servi√ßo" para come√ßar.</p>
    </div>
  </div>

  <!-- Conte√∫do: Barbeiros -->
  <div id="conteudoBarbeiros" class="tab-content hidden">
    <!-- Bot√£o para novo barbeiro -->
    <button id="btnNovoBarbeiro" 
      class="mb-6 bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-lg font-semibold">
      + Novo Barbeiro
    </button>

    <!-- Formul√°rio de Barbeiro (oculto inicialmente) -->
    <div id="formBarbeiro" class="hidden bg-slate-900 p-6 rounded-xl mb-6 border border-slate-800">
      <h3 class="text-xl font-bold mb-4">Cadastrar Novo Barbeiro</h3>
      
      <div class="grid md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-2">Nome do Barbeiro</label>
          <input id="inputNomeBarbeiro" type="text" 
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="Ex: Jo√£o Silva">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Email</label>
          <input id="inputEmailBarbeiro" type="email" 
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="email@exemplo.com">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Senha</label>
          <input id="inputSenhaBarbeiro" type="password" 
            class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" 
            placeholder="M√≠nimo 6 caracteres">
        </div>
      </div>
      
      <div class="flex gap-3">
        <button id="btnSalvarBarbeiro" 
          class="bg-green-500 hover:bg-green-600 text-black px-6 py-2 rounded-lg font-semibold">
          Cadastrar
        </button>
        <button id="btnCancelarFormBarbeiro" 
          class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold">
          Cancelar
        </button>
      </div>
    </div>

    <!-- Lista de Barbeiros -->
    <div id="listaBarbeiros" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Barbeiros ser√£o inseridos aqui -->
</div>

    <div id="mensagemVaziaBarbeiros" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg">Nenhum barbeiro cadastrado.</p>
      <p class="text-sm mt-2">Clique em "Novo Barbeiro" para come√ßar.</p>
    </div>
  </div>
  </div>
</div>

<script type="module">
import { supabase } from './js/supabase.js'

let barbeariaId = null
let todosAgendamentos = []
let servicoEditando = null

// Elementos
const userName = document.getElementById('userName')
const barbeariaName = document.getElementById('barbeariaName')
const btnLogout = document.getElementById('btnLogout')
const listaAgendamentos = document.getElementById('listaAgendamentos')
const mensagemVaziaAgendamentos = document.getElementById('mensagemVaziaAgendamentos')
const listaServicos = document.getElementById('listaServicos')
const mensagemVaziaServicos = document.getElementById('mensagemVaziaServicos')
const filtroData = document.getElementById('filtroData')
const filtroStatus = document.getElementById('filtroStatus')
const btnLimparFiltros = document.getElementById('btnLimparFiltros')
const statAgendamentos = document.getElementById('statAgendamentos')
const statBarbeiros = document.getElementById('statBarbeiros')
const statServicos = document.getElementById('statServicos')
const statPendentes = document.getElementById('statPendentes')

// Tabs
const tabAgendamentos = document.getElementById('tabAgendamentos')
const tabServicos = document.getElementById('tabServicos')
const tabBarbeiros = document.getElementById('tabBarbeiros')
const conteudoAgendamentos = document.getElementById('conteudoAgendamentos')
const conteudoServicos = document.getElementById('conteudoServicos')
const conteudoBarbeiros = document.getElementById('conteudoBarbeiros')

// Formul√°rio de Servi√ßo
const btnNovoServico = document.getElementById('btnNovoServico')
const formServico = document.getElementById('formServico')
const btnSalvarServico = document.getElementById('btnSalvarServico')
const btnCancelarFormServico = document.getElementById('btnCancelarFormServico')
const inputNomeServico = document.getElementById('inputNomeServico')
const inputDuracaoServico = document.getElementById('inputDuracaoServico')
const inputPrecoServico = document.getElementById('inputPrecoServico')
const formTitleServico = document.getElementById('formTitleServico')

// Formul√°rio de Barbeiro
const btnNovoBarbeiro = document.getElementById('btnNovoBarbeiro')
const formBarbeiro = document.getElementById('formBarbeiro')
const btnSalvarBarbeiro = document.getElementById('btnSalvarBarbeiro')
const btnCancelarFormBarbeiro = document.getElementById('btnCancelarFormBarbeiro')
const inputNomeBarbeiro = document.getElementById('inputNomeBarbeiro')
const inputEmailBarbeiro = document.getElementById('inputEmailBarbeiro')
const inputSenhaBarbeiro = document.getElementById('inputSenhaBarbeiro')
const listaBarbeiros = document.getElementById('listaBarbeiros')
const mensagemVaziaBarbeiros = document.getElementById('mensagemVaziaBarbeiros')

// Carregar dados do usu√°rio
const { data: userData } = await supabase.auth.getUser()
if (!userData.user) {
  window.location.href = 'login.html'
}

const { data: profile, error: profileError } = await supabase
  .from('profiles')
  .select('nome, barbearia_id, role')
  .eq('id', userData.user.id)
  .single()

let barbeariaNome = '';
if (profile?.barbearia_id) {
  const { data: barbearia } = await supabase
    .from('barbearias')
    .select('nome')
    .eq('id', profile.barbearia_id)
    .single();
  barbeariaNome = barbearia?.nome || '';
}

let deveContinuar = true

if (profileError) {
  deveContinuar = false
  // Se o erro √© porque n√£o encontrou o perfil (c√≥digo PGRST116), criar um perfil b√°sico
  if (profileError.code === 'PGRST116' || profileError.message.includes('No rows')) {
    alert('Perfil n√£o encontrado. Por favor, crie uma conta primeiro.')
    await supabase.auth.signOut()
    window.location.href = 'register.html'
  } else {
    console.error('Erro ao carregar perfil:', profileError)
    alert('Erro ao carregar perfil: ' + profileError.message)
    await supabase.auth.signOut()
    window.location.href = 'login.html'
  }
}

if (!profile) {
  deveContinuar = false
  alert('Perfil n√£o encontrado. Por favor, crie uma conta primeiro.')
  await supabase.auth.signOut()
  window.location.href = 'register.html'
}

// Elementos de configura√ß√£o inicial (sempre carregar, mesmo se houver erro depois)
const configuracaoInicial = document.getElementById('configuracaoInicial')
const dashboardPrincipal = document.getElementById('dashboardPrincipal')

// Se n√£o deve continuar, parar aqui
if (!deveContinuar || !profile) {
  // C√≥digo j√° foi redirecionado acima, n√£o continuar execu√ß√£o
  // Mas garantir que algo seja mostrado
  if (configuracaoInicial) configuracaoInicial.classList.remove('hidden')
  if (dashboardPrincipal) dashboardPrincipal.classList.add('hidden')
} else {
userName.textContent = profile?.nome || 'Admin'
const inputNomeBarbearia = document.getElementById('inputNomeBarbearia')
const selectBarbeariaExistente = document.getElementById('selectBarbeariaExistente')
const btnCriarBarbearia = document.getElementById('btnCriarBarbearia')
const btnAssociarBarbearia = document.getElementById('btnAssociarBarbearia')

// Verificar se tem barbearia (s√≥ mostrar tela de configura√ß√£o se realmente n√£o tiver e for admin)
if (profile && profile.role === 'admin' && !profile.barbearia_id) {
  // Mostrar tela de configura√ß√£o inicial
  if (configuracaoInicial) configuracaoInicial.classList.remove('hidden')
  if (dashboardPrincipal) dashboardPrincipal.classList.add('hidden')
  
  // Vari√°vel para armazenar barbearias
  let listaBarbearias = []
  
  // Carregar barbearias existentes
  const { data: barbeariasData } = await supabase
    .from('barbearias')
    .select('id, nome')
    .eq('ativo', true)
    .order('nome')
  
  listaBarbearias = barbeariasData || []
  
  selectBarbeariaExistente.innerHTML = '<option value="">Selecione uma barbearia</option>'
  if (listaBarbearias.length > 0) {
    listaBarbearias.forEach(b => {
      selectBarbeariaExistente.innerHTML += `<option value="${b.id}">${b.nome}</option>`
    })
  } else {
    selectBarbeariaExistente.innerHTML = '<option value="">Nenhuma barbearia dispon√≠vel</option>'
  }
  
  // Criar nova barbearia
  btnCriarBarbearia.addEventListener('click', async () => {
    if (!inputNomeBarbearia.value.trim()) {
      alert('Digite o nome da barbearia!')
      return
    }
    
    const { data: novaBarbearia, error } = await supabase
      .from('barbearias')
      .insert({
        nome: inputNomeBarbearia.value.trim(),
        ativo: true
      })
      .select()
      .single()
    
    if (error) {
      alert('Erro ao criar barbearia: ' + error.message)
      return
    }
    
    // Associar admin √† barbearia
    const { error: updateError } = await supabase
      .from('profiles')
      .update({ barbearia_id: novaBarbearia.id })
      .eq('id', userData.user.id)
    
    if (updateError) {
      alert('Erro ao associar barbearia: ' + updateError.message)
      return
    }
    
    // Atualizar vari√°veis e interface sem recarregar
    barbeariaId = novaBarbearia.id
    barbeariaName.textContent = novaBarbearia.nome
    
    // Esconder tela de configura√ß√£o e mostrar dashboard
    configuracaoInicial.classList.add('hidden')
    dashboardPrincipal.classList.remove('hidden')
    
    // Inicializar dashboard
    await carregarEstatisticas()
    await carregarAgendamentos()
    await carregarServicos()
    await carregarBarbeiros()
    
    alert('Barbearia criada e associada com sucesso!')
  })
  
  // Associar barbearia existente
  btnAssociarBarbearia.addEventListener('click', async () => {
    if (!selectBarbeariaExistente.value) {
      alert('Selecione uma barbearia!')
      return
    }
    
    const barbeariaSelecionada = listaBarbearias.find(b => b.id === selectBarbeariaExistente.value)
    
    const { error } = await supabase
      .from('profiles')
      .update({ barbearia_id: selectBarbeariaExistente.value })
      .eq('id', userData.user.id)
    
    if (error) {
      alert('Erro ao associar barbearia: ' + error.message)
      return
    }
    
    // Atualizar vari√°veis e interface sem recarregar
    barbeariaId = selectBarbeariaExistente.value
    barbeariaName.textContent = barbeariaSelecionada?.nome || ''
    
    // Esconder tela de configura√ß√£o e mostrar dashboard
    configuracaoInicial.classList.add('hidden')
    dashboardPrincipal.classList.remove('hidden')
    
    // Inicializar dashboard
    await carregarEstatisticas()
    await carregarAgendamentos()
    await carregarServicos()
    await carregarBarbeiros()
    
    alert('Barbearia associada com sucesso!')
  })
  
}

// Se chegou aqui e tem perfil COM barbearia, mostrar dashboard
if (deveContinuar && profile && profile.barbearia_id) {
  // Mostrar dashboard principal (tem barbearia)
  if (configuracaoInicial) configuracaoInicial.classList.add('hidden')
  if (dashboardPrincipal) dashboardPrincipal.classList.remove('hidden')
  
  barbeariaId = profile.barbearia_id
  if (barbeariaName) barbeariaName.textContent = barbeariaNome || ''
  
  // Inicializar dashboard
  await carregarEstatisticas()
  await carregarAgendamentos()
  await carregarServicos()
  await carregarBarbeiros()
}

// Carregar estat√≠sticas
async function carregarEstatisticas() {
  const hoje = new Date().toISOString().split('T')[0]
  
  // Agendamentos hoje
  const { count: countHoje } = await supabase
    .from('agendamentos')
    .select('*', { count: 'exact', head: true })
    .eq('barbearia_id', barbeariaId)
    .eq('data', hoje)
  
  // Barbeiros
  const { count: countBarbeiros } = await supabase
    .from('profiles')
    .select('*', { count: 'exact', head: true })
    .eq('barbearia_id', barbeariaId)
    .eq('role', 'barbeiro')
  
  // Servi√ßos
  const { count: countServicos } = await supabase
    .from('servicos')
    .select('*', { count: 'exact', head: true })
    .eq('barbearia_id', barbeariaId)
  
  // Pendentes
  const { count: countPendentes } = await supabase
    .from('agendamentos')
    .select('*', { count: 'exact', head: true })
    .eq('barbearia_id', barbeariaId)
    .eq('status', 'pendente')
  
  statAgendamentos.textContent = countHoje || 0
  statBarbeiros.textContent = countBarbeiros || 0
  statServicos.textContent = countServicos || 0
  statPendentes.textContent = countPendentes || 0
}

// Carregar agendamentos
async function carregarAgendamentos() {
const { data: agendamentos } = await supabase
  .from('agendamentos')
    .select(`
      *,
      servicos(nome, preco, duracao)
    `)
    .eq('barbearia_id', barbeariaId)
    .order('data', { ascending: true })
    .order('hora', { ascending: true })
  
  if (agendamentos && agendamentos.length > 0) {
    // Buscar dados dos perfis separadamente
    const clienteIds = [...new Set(agendamentos.map(a => a.cliente_id))]
    const barbeiroIds = [...new Set(agendamentos.map(a => a.barbeiro_id))]
    
    const { data: clientes } = await supabase
      .from('profiles')
      .select('id, nome')
      .in('id', clienteIds)
    
    const { data: barbeiros } = await supabase
      .from('profiles')
      .select('id, nome')
      .in('id', barbeiroIds)
    
    const clientesMap = {}
    const barbeirosMap = {}
    
    clientes?.forEach(c => clientesMap[c.id] = c)
    barbeiros?.forEach(b => barbeirosMap[b.id] = b)
    
    // Adicionar dados aos agendamentos
    agendamentos.forEach(a => {
      a.cliente = clientesMap[a.cliente_id] || { nome: 'N√£o informado' }
      a.barbeiro = barbeirosMap[a.barbeiro_id] || { nome: 'N√£o informado' }
    })
  }
  
  todosAgendamentos = agendamentos || []
  aplicarFiltros()
}

// Aplicar filtros
function aplicarFiltros() {
  let agendamentosFiltrados = [...todosAgendamentos]
  
  if (filtroData.value) {
    agendamentosFiltrados = agendamentosFiltrados.filter(a => a.data === filtroData.value)
  }
  
  if (filtroStatus.value) {
    agendamentosFiltrados = agendamentosFiltrados.filter(a => a.status === filtroStatus.value)
  }
  
  renderizarAgendamentos(agendamentosFiltrados)
}

// Renderizar agendamentos
function renderizarAgendamentos(agendamentos) {
  if (!agendamentos || agendamentos.length === 0) {
    listaAgendamentos.classList.add('hidden')
    mensagemVaziaAgendamentos.classList.remove('hidden')
    return
  }
  
  listaAgendamentos.classList.remove('hidden')
  mensagemVaziaAgendamentos.classList.add('hidden')
  
  listaAgendamentos.innerHTML = ''

agendamentos.forEach(a => {
    const dataFormatada = new Date(a.data + 'T00:00:00').toLocaleDateString('pt-BR')
    const servico = a.servicos || {}
    const cliente = a.cliente || {}
    const barbeiro = a.barbeiro || {}
    
    const statusClass = {
      'confirmado': 'bg-green-500/20 text-green-400 border-green-500/30',
      'cancelado': 'bg-red-500/20 text-red-400 border-red-500/30',
      'concluido': 'bg-blue-500/20 text-blue-400 border-blue-500/30',
      'pendente': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'
    }[a.status] || 'bg-gray-500/20 text-gray-400 border-gray-500/30'
    
    listaAgendamentos.innerHTML += `
      <div class="bg-slate-900 p-6 rounded-xl border ${statusClass.split(' ')[2]} hover:border-opacity-60 transition">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold mb-1">${cliente.nome || 'Cliente n√£o informado'}</h3>
            <p class="text-gray-400">${servico.nome || 'Servi√ßo n√£o informado'}</p>
          </div>
          <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
            ${a.status || 'pendente'}
          </span>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4 mb-4 text-gray-300">
          <div>
            <span class="text-gray-500">üìÖ Data:</span> ${dataFormatada}
          </div>
          <div>
            <span class="text-gray-500">‚è∞ Hora:</span> ${a.hora}
          </div>
          <div>
            <span class="text-gray-500">üíá Barbeiro:</span> ${barbeiro.nome || 'N√£o informado'}
          </div>
          <div>
            <span class="text-gray-500">üí∞ Valor:</span> R$ ${parseFloat(servico.preco || 0).toFixed(2)}
          </div>
        </div>
      </div>
    `
  })
}

// Carregar servi√ßos
async function carregarServicos() {
  const { data: servicos } = await supabase
    .from('servicos')
    .select('*')
    .eq('barbearia_id', barbeariaId)
    .order('nome')
  
  if (!servicos || servicos.length === 0) {
    listaServicos.classList.add('hidden')
    mensagemVaziaServicos.classList.remove('hidden')
    return
  }
  
  listaServicos.classList.remove('hidden')
  mensagemVaziaServicos.classList.add('hidden')
  
  listaServicos.innerHTML = ''
  
  servicos.forEach(s => {
    listaServicos.innerHTML += `
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 hover:border-slate-700 transition">
        <h3 class="text-xl font-bold mb-2">${s.nome}</h3>
        <div class="space-y-2 text-gray-300 mb-4">
          <div><span class="text-gray-500">‚è±Ô∏è Dura√ß√£o:</span> ${s.duracao} minutos</div>
          <div><span class="text-gray-500">üí∞ Pre√ßo:</span> R$ ${parseFloat(s.preco).toFixed(2)}</div>
        </div>
        <div class="flex gap-3">
          <button onclick="editarServico('${s.id}', '${s.nome.replace(/'/g, "\\'")}', ${s.duracao}, ${s.preco})" 
            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Editar
          </button>
          <button onclick="excluirServico('${s.id}')" 
            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Excluir
          </button>
        </div>
      </div>
    `
  })
}

// Fun√ß√µes globais
window.editarServico = (id, nome, duracao, preco) => {
  servicoEditando = id
  formTitleServico.textContent = 'Editar Servi√ßo'
  formServico.classList.remove('hidden')
  inputNomeServico.value = nome
  inputDuracaoServico.value = duracao
  inputPrecoServico.value = preco
  window.scrollTo({ top: 0, behavior: 'smooth' })
}

window.excluirServico = async (id) => {
  if (!confirm('Tem certeza que deseja excluir este servi√ßo?')) return
  
  const { error } = await supabase
    .from('servicos')
    .delete()
    .eq('id', id)
  
  if (error) {
    alert('Erro ao excluir servi√ßo: ' + error.message)
    return
  }
  
  alert('Servi√ßo exclu√≠do com sucesso!')
  await carregarServicos()
  await carregarEstatisticas()
}

// Carregar barbeiros
async function carregarBarbeiros() {
  const { data: barbeiros } = await supabase
    .from('profiles')
    .select('id, nome')
    .eq('barbearia_id', barbeariaId)
    .eq('role', 'barbeiro')
    .order('nome')
  
  if (!barbeiros || barbeiros.length === 0) {
    listaBarbeiros.classList.add('hidden')
    mensagemVaziaBarbeiros.classList.remove('hidden')
    return
  }
  
  listaBarbeiros.classList.remove('hidden')
  mensagemVaziaBarbeiros.classList.add('hidden')
  
  listaBarbeiros.innerHTML = ''
  
  barbeiros.forEach(b => {
    const linkAgendamento = `${window.location.origin}${window.location.pathname.replace('admin.html', 'agendar.html')}?barbeiro=${b.id}`
    
    listaBarbeiros.innerHTML += `
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 hover:border-slate-700 transition">
        <h3 class="text-xl font-bold mb-2">${b.nome}</h3>
        <div class="space-y-2 text-gray-300 mb-4">
          <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
            <div class="text-xs text-gray-400 mb-1">Link de Agendamento:</div>
            <div class="flex items-center gap-2">
              <input type="text" value="${linkAgendamento}" readonly 
                class="flex-1 bg-slate-900 text-sm p-2 rounded border border-slate-700 text-gray-300">
              <button onclick="copiarLink('${linkAgendamento}')" 
                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold">
                Copiar
              </button>
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <button onclick="excluirBarbeiro('${b.id}', '${b.nome.replace(/'/g, "\\'")}')" 
            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Excluir
          </button>
        </div>
    </div>
  `
})
}

// Fun√ß√£o para copiar link
window.copiarLink = async (link) => {
  try {
    await navigator.clipboard.writeText(link)
    alert('Link copiado para a √°rea de transfer√™ncia!')
  } catch (err) {
    // Fallback para navegadores antigos
    const input = document.createElement('input')
    input.value = link
    document.body.appendChild(input)
    input.select()
    document.execCommand('copy')
    document.body.removeChild(input)
    alert('Link copiado para a √°rea de transfer√™ncia!')
  }
}

// Fun√ß√µes globais
window.excluirBarbeiro = async (id, nome) => {
  if (!confirm(`Tem certeza que deseja excluir o barbeiro "${nome}"? Esta a√ß√£o n√£o pode ser desfeita.`)) return
  
  const { error } = await supabase
    .from('profiles')
    .delete()
    .eq('id', id)
  
  if (error) {
    alert('Erro ao excluir barbeiro: ' + error.message)
    return
  }
  
  alert('Barbeiro exclu√≠do com sucesso!')
  await carregarBarbeiros()
  await carregarEstatisticas()
}

// Event listeners - Tabs
tabAgendamentos.addEventListener('click', () => {
  tabAgendamentos.classList.add('active', 'border-green-500')
  tabServicos.classList.remove('active', 'border-green-500')
  tabBarbeiros.classList.remove('active', 'border-green-500')
  conteudoAgendamentos.classList.remove('hidden')
  conteudoServicos.classList.add('hidden')
  conteudoBarbeiros.classList.add('hidden')
})

tabServicos.addEventListener('click', () => {
  tabServicos.classList.add('active', 'border-green-500')
  tabAgendamentos.classList.remove('active', 'border-green-500')
  tabBarbeiros.classList.remove('active', 'border-green-500')
  conteudoServicos.classList.remove('hidden')
  conteudoAgendamentos.classList.add('hidden')
  conteudoBarbeiros.classList.add('hidden')
})

tabBarbeiros.addEventListener('click', () => {
  tabBarbeiros.classList.add('active', 'border-green-500')
  tabAgendamentos.classList.remove('active', 'border-green-500')
  tabServicos.classList.remove('active', 'border-green-500')
  conteudoBarbeiros.classList.remove('hidden')
  conteudoAgendamentos.classList.add('hidden')
  conteudoServicos.classList.add('hidden')
})

// Event listeners - Filtros
filtroData.addEventListener('change', aplicarFiltros)
filtroStatus.addEventListener('change', aplicarFiltros)
btnLimparFiltros.addEventListener('click', () => {
  filtroData.value = ''
  filtroStatus.value = ''
  aplicarFiltros()
})

// Event listeners - Servi√ßos
btnNovoServico.addEventListener('click', () => {
  servicoEditando = null
  formTitleServico.textContent = 'Novo Servi√ßo'
  formServico.classList.remove('hidden')
  inputNomeServico.value = ''
  inputDuracaoServico.value = ''
  inputPrecoServico.value = ''
  window.scrollTo({ top: 0, behavior: 'smooth' })
})

btnCancelarFormServico.addEventListener('click', () => {
  formServico.classList.add('hidden')
  servicoEditando = null
})

btnSalvarServico.addEventListener('click', async () => {
  if (!inputNomeServico.value || !inputDuracaoServico.value || !inputPrecoServico.value) {
    alert('Preencha todos os campos!')
    return
  }
  
  const dados = {
    nome: inputNomeServico.value,
    duracao: parseInt(inputDuracaoServico.value),
    preco: parseFloat(inputPrecoServico.value),
    barbearia_id: barbeariaId
  }
  
  let error
  
  if (servicoEditando) {
    const { error: updateError } = await supabase
      .from('servicos')
      .update(dados)
      .eq('id', servicoEditando)
    error = updateError
  } else {
    const { error: insertError } = await supabase
      .from('servicos')
      .insert(dados)
    error = insertError
  }
  
  if (error) {
    alert('Erro ao salvar servi√ßo: ' + error.message)
    return
  }
  
  alert(servicoEditando ? 'Servi√ßo atualizado com sucesso!' : 'Servi√ßo criado com sucesso!')
  formServico.classList.add('hidden')
  servicoEditando = null
  await carregarServicos()
  await carregarEstatisticas()
})

// Event listeners - Barbeiros
btnNovoBarbeiro.addEventListener('click', () => {
  formBarbeiro.classList.remove('hidden')
  inputNomeBarbeiro.value = ''
  inputEmailBarbeiro.value = ''
  inputSenhaBarbeiro.value = ''
  window.scrollTo({ top: 0, behavior: 'smooth' })
})

btnCancelarFormBarbeiro.addEventListener('click', () => {
  formBarbeiro.classList.add('hidden')
})

btnSalvarBarbeiro.addEventListener('click', async () => {
  if (!inputNomeBarbeiro.value.trim() || !inputEmailBarbeiro.value.trim() || !inputSenhaBarbeiro.value.trim()) {
    alert('Preencha todos os campos!')
    return
  }
  
  if (inputSenhaBarbeiro.value.length < 6) {
    alert('A senha deve ter no m√≠nimo 6 caracteres!')
    return
  }
  
  // Criar usu√°rio via signup (m√©todo dispon√≠vel no cliente)
  const { data: authData, error: authError } = await supabase.auth.signUp({
    email: inputEmailBarbeiro.value.trim(),
    password: inputSenhaBarbeiro.value
  })
  
  if (authError) {
    alert('Erro ao criar usu√°rio: ' + authError.message)
    return
  }
  
  if (!authData.user) {
    alert('Erro: usu√°rio n√£o foi criado')
    return
  }
  
  // Criar perfil
  const { error: profileError } = await supabase
    .from('profiles')
    .insert({
      id: authData.user.id,
      nome: inputNomeBarbeiro.value.trim(),
      role: 'barbeiro',
      barbearia_id: barbeariaId
    })
  
  if (profileError) {
    alert('Erro ao criar perfil: ' + profileError.message + '\nO usu√°rio foi criado mas o perfil n√£o. Entre em contato com o suporte.')
    return
  }
  
  alert('Barbeiro cadastrado com sucesso!')
  formBarbeiro.classList.add('hidden')
  inputNomeBarbeiro.value = ''
  inputEmailBarbeiro.value = ''
  inputSenhaBarbeiro.value = ''
  await carregarBarbeiros()
  await carregarEstatisticas()
})

btnLogout.addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

// Inicializa√ß√£o j√° foi feita acima quando verificamos se tem barbearia
}
</script>

</body>
</html>
