<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cliente | AgendaBarber</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen">

<!-- Header -->
<header class="bg-slate-900 border-b border-slate-800 px-8 py-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">Agenda<span class="text-green-500">Barber</span></h1>
  <div class="flex gap-4 items-center">
    <span id="userName" class="text-gray-300"></span>
    <button id="btnLogout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-semibold">
      Sair
    </button>
  </div>
</header>

<div class="max-w-6xl mx-auto px-6 py-8">
  <h2 class="text-3xl font-bold mb-6">Meus Agendamentos</h2>

  <!-- Bot√£o para novo agendamento -->
  <button id="btnNovoAgendamento" 
    class="mb-6 bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-lg font-semibold">
    + Novo Agendamento
  </button>

  <!-- Formul√°rio de Agendamento (oculto inicialmente) -->
  <div id="formAgendamento" class="hidden bg-slate-900 p-6 rounded-xl mb-6 border border-slate-800">
    <h3 class="text-xl font-bold mb-4" id="formTitle">Novo Agendamento</h3>
    
    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium mb-2">Barbearia</label>
        <select id="selectBarbearia" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700">
          <option value="">Selecione uma barbearia</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Barbeiro</label>
        <select id="selectBarbeiro" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" disabled>
          <option value="">Selecione um barbeiro</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Servi√ßo</label>
        <select id="selectServico" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" disabled>
          <option value="">Selecione um servi√ßo</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Data</label>
        <input id="inputData" type="date" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700" min="">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Hora</label>
        <input id="inputHora" type="time" class="w-full p-3 bg-slate-800 rounded-lg border border-slate-700">
      </div>
    </div>
    
    <div class="flex gap-3">
      <button id="btnSalvarAgendamento" 
        class="bg-green-500 hover:bg-green-600 text-black px-6 py-2 rounded-lg font-semibold">
        Salvar
      </button>
      <button id="btnCancelarForm" 
        class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded-lg font-semibold">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Lista de Agendamentos -->
  <div id="listaAgendamentos" class="space-y-4">
    <!-- Agendamentos ser√£o inseridos aqui -->
  </div>

  <div id="mensagemVazia" class="hidden text-center py-12 text-gray-400">
    <p class="text-lg">Nenhum agendamento encontrado.</p>
    <p class="text-sm mt-2">Clique em "Novo Agendamento" para come√ßar.</p>
  </div>
</div>

<script type="module">
import { supabase } from './js/supabase.js'

let agendamentoEditando = null
let barbearias = []
let barbeiros = []
let servicos = []

// Elementos
const btnNovoAgendamento = document.getElementById('btnNovoAgendamento')
const formAgendamento = document.getElementById('formAgendamento')
const btnSalvarAgendamento = document.getElementById('btnSalvarAgendamento')
const btnCancelarForm = document.getElementById('btnCancelarForm')
const btnLogout = document.getElementById('btnLogout')
const listaAgendamentos = document.getElementById('listaAgendamentos')
const mensagemVazia = document.getElementById('mensagemVazia')
const selectBarbearia = document.getElementById('selectBarbearia')
const selectBarbeiro = document.getElementById('selectBarbeiro')
const selectServico = document.getElementById('selectServico')
const inputData = document.getElementById('inputData')
const inputHora = document.getElementById('inputHora')
const formTitle = document.getElementById('formTitle')
const userName = document.getElementById('userName')

// Data m√≠nima = hoje
inputData.min = new Date().toISOString().split('T')[0]

// Carregar dados do usu√°rio
const { data: userData } = await supabase.auth.getUser()
if (!userData.user) {
  window.location.href = 'login.html'
}

const { data: profile } = await supabase
  .from('profiles')
  .select('nome')
  .eq('id', userData.user.id)
  .single()

userName.textContent = profile?.nome || 'Cliente'

// Carregar barbearias
async function carregarBarbearias() {
  const { data } = await supabase
    .from('barbearias')
    .select('*')
    .eq('ativo', true)
    .order('nome')
  
  barbearias = data || []
  selectBarbearia.innerHTML = '<option value="">Selecione uma barbearia</option>'
  barbearias.forEach(b => {
    selectBarbearia.innerHTML += `<option value="${b.id}">${b.nome}</option>`
  })
}

// Carregar barbeiros da barbearia selecionada
async function carregarBarbeiros(barbeariaId) {
  selectBarbeiro.disabled = !barbeariaId
  selectServico.disabled = !barbeariaId
  
  if (!barbeariaId) {
    selectBarbeiro.innerHTML = '<option value="">Selecione um barbeiro</option>'
    selectServico.innerHTML = '<option value="">Selecione um servi√ßo</option>'
    return
  }

  const { data } = await supabase
    .from('profiles')
    .select('*')
    .eq('barbearia_id', barbeariaId)
    .eq('role', 'barbeiro')
    .order('nome')
  
  barbeiros = data || []
  selectBarbeiro.innerHTML = '<option value="">Selecione um barbeiro</option>'
  barbeiros.forEach(b => {
    selectBarbeiro.innerHTML += `<option value="${b.id}">${b.nome}</option>`
  })

  carregarServicos(barbeariaId)
}

// Carregar servi√ßos da barbearia
async function carregarServicos(barbeariaId) {
  const { data } = await supabase
    .from('servicos')
    .select('*')
    .eq('barbearia_id', barbeariaId)
    .order('nome')
  
  servicos = data || []
  selectServico.innerHTML = '<option value="">Selecione um servi√ßo</option>'
  servicos.forEach(s => {
    selectServico.innerHTML += `<option value="${s.id}">${s.nome} (R$ ${s.preco})</option>`
  })
}

// Carregar agendamentos do cliente
async function carregarAgendamentos() {
  const { data: agendamentos } = await supabase
    .from('agendamentos')
    .select('*, barbearias(nome), barbeiros:profiles!barbeiro_id(nome), servicos(nome, preco)')
    .eq('cliente_id', userData.user.id)
    .gte('data', new Date().toISOString().split('T')[0])
    .order('data', { ascending: true })
    .order('hora', { ascending: true })

  if (!agendamentos || agendamentos.length === 0) {
    listaAgendamentos.innerHTML = ''
    mensagemVazia.classList.remove('hidden')
    return
  }

  mensagemVazia.classList.add('hidden')
  
  let html = ''
  for (const age of agendamentos) {
    const statusCores = {
      pendente: 'yellow',
      confirmado: 'green',
      concluido: 'blue',
      cancelado: 'red'
    }
    const corStatus = statusCores[age.status] || 'gray'
    const dataFormatada = new Date(age.data).toLocaleDateString('pt-BR')
    
    html += `
      <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 hover:border-green-500 transition">
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1">
            <div class="text-gray-400 text-sm">${age.barbearias?.nome}</div>
            <div class="font-bold text-lg mb-2">${age.servicos?.nome}</div>
            <div class="text-sm text-gray-400">
              <span>üìÖ ${dataFormatada}</span>
              <span class="ml-4">üïê ${age.hora}</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-green-400">R$ ${age.servicos?.preco}</div>
            <span class="text-xs bg-${corStatus}-900 text-${corStatus}-200 px-2 py-1 rounded inline-block mt-2">${age.status}</span>
          </div>
        </div>
        
        ${age.status === 'pendente' || age.status === 'confirmado' ? `
          <div class="flex gap-2 border-t border-slate-700 pt-3 mt-3">
            <button onclick="editarAgendamento('${age.id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold">
              Editar
            </button>
            <button onclick="cancelarAgendamento('${age.id}')" class="flex-1 bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm font-semibold">
              Cancelar
            </button>
          </div>
        ` : ''}
      </div>
    `
  }
  
  listaAgendamentos.innerHTML = html
}

// Event listeners
btnNovoAgendamento.addEventListener('click', () => {
  agendamentoEditando = null
  formTitle.textContent = 'Novo Agendamento'
  selectBarbearia.value = ''
  selectBarbeiro.value = ''
  selectServico.value = ''
  inputData.value = ''
  inputHora.value = ''
  selectBarbeiro.disabled = true
  selectServico.disabled = true
  formAgendamento.classList.remove('hidden')
})

btnCancelarForm.addEventListener('click', () => {
  agendamentoEditando = null
  formAgendamento.classList.add('hidden')
})

selectBarbearia.addEventListener('change', (e) => {
  carregarBarbeiros(e.target.value)
})

// Editar agendamento
window.editarAgendamento = async (id) => {
  const { data: age } = await supabase
    .from('agendamentos')
    .select('*')
    .eq('id', id)
    .single()
  
  agendamentoEditando = id
  formTitle.textContent = 'Editar Agendamento'
  selectBarbearia.value = age.barbearia_id
  await carregarBarbeiros(age.barbearia_id)
  selectBarbeiro.value = age.barbeiro_id
  selectServico.value = age.servico_id
  inputData.value = age.data
  inputHora.value = age.hora
  formAgendamento.classList.remove('hidden')
}

// Cancelar agendamento
window.cancelarAgendamento = async (id) => {
  if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return
  
  const { error } = await supabase
    .from('agendamentos')
    .update({ status: 'cancelado' })
    .eq('id', id)
  
  if (error) {
    alert('Erro ao cancelar: ' + error.message)
    return
  }
  
  alert('Agendamento cancelado com sucesso!')
  carregarAgendamentos()
}

// Salvar agendamento
btnSalvarAgendamento.addEventListener('click', async () => {
  if (!selectBarbearia.value || !selectBarbeiro.value || !selectServico.value || !inputData.value || !inputHora.value) {
    alert('Preencha todos os campos')
    return
  }

  const dados = {
    barbearia_id: selectBarbearia.value,
    barbeiro_id: selectBarbeiro.value,
    servico_id: selectServico.value,
    data: inputData.value,
    hora: inputHora.value,
    status: 'pendente'
  }
  
  let error

  if (agendamentoEditando) {
    const { error: updateError } = await supabase
      .from('agendamentos')
      .update(dados)
      .eq('id', agendamentoEditando)
    error = updateError
  } else {
    dados.cliente_id = userData.user.id
    const { error: insertError } = await supabase
      .from('agendamentos')
      .insert([dados])
    error = insertError
  }

  if (error) {
    alert('Erro ao salvar agendamento: ' + error.message)
    return
  }

  alert(agendamentoEditando ? 'Agendamento atualizado com sucesso!' : 'Agendamento criado com sucesso!')
  formAgendamento.classList.add('hidden')
  agendamentoEditando = null
  carregarAgendamentos()
})

btnLogout.addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

// Inicializar
carregarBarbearias()
carregarAgendamentos()

</script>

</body>
</html>
    return
  }
  
  const { data } = await supabase
    .from('profiles')
    .select('id, nome')
    .eq('barbearia_id', barbeariaId)
    .eq('role', 'barbeiro')
    .order('nome')
  
  barbeiros = data || []
  selectBarbeiro.innerHTML = '<option value="">Selecione um barbeiro</option>'
  barbeiros.forEach(b => {
    selectBarbeiro.innerHTML += `<option value="${b.id}">${b.nome}</option>`
  })
}

// Carregar servi√ßos da barbearia selecionada
async function carregarServicos(barbeariaId) {
  selectServico.disabled = !barbeariaId
  if (!barbeariaId) {
    selectServico.innerHTML = '<option value="">Selecione um servi√ßo</option>'
    return
  }
  
  const { data } = await supabase
    .from('servicos')
    .select('*')
    .eq('barbearia_id', barbeariaId)
    .order('nome')
  
  servicos = data || []
  selectServico.innerHTML = '<option value="">Selecione um servi√ßo</option>'
  servicos.forEach(s => {
    selectServico.innerHTML += `<option value="${s.id}">${s.nome} - R$ ${parseFloat(s.preco).toFixed(2)} (${s.duracao}min)</option>`
  })
}

// Carregar agendamentos do cliente
async function carregarAgendamentos() {
  const { data: agendamentos } = await supabase
    .from('agendamentos')
    .select(`
      *,
      barbearias(nome),
      servicos(nome, preco, duracao),
      barbeiro:profiles!agendamentos_barbeiro_id_fkey(nome)
    `)
    .eq('cliente_id', userData.user.id)
    .order('data', { ascending: true })
    .order('hora', { ascending: true })
  
  if (!agendamentos || agendamentos.length === 0) {
    listaAgendamentos.classList.add('hidden')
    mensagemVazia.classList.remove('hidden')
    return
  }
  
  listaAgendamentos.classList.remove('hidden')
  mensagemVazia.classList.add('hidden')
  
  listaAgendamentos.innerHTML = ''
  
  agendamentos.forEach(a => {
    const dataFormatada = new Date(a.data + 'T00:00:00').toLocaleDateString('pt-BR')
    const servico = a.servicos || {}
    const barbeiro = a.barbeiro || {}
    const barbearia = a.barbearias || {}
    
    const statusClass = {
      'confirmado': 'bg-green-500/20 text-green-400',
      'cancelado': 'bg-red-500/20 text-red-400',
      'concluido': 'bg-blue-500/20 text-blue-400',
      'pendente': 'bg-yellow-500/20 text-yellow-400'
    }[a.status] || 'bg-gray-500/20 text-gray-400'
    
    listaAgendamentos.innerHTML += `
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 hover:border-slate-700 transition">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold mb-1">${servico.nome || 'Servi√ßo n√£o informado'}</h3>
            <p class="text-gray-400">${barbearia.nome || 'Barbearia'}</p>
          </div>
          <span class="px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
            ${a.status || 'pendente'}
          </span>
        </div>
        
        <div class="grid md:grid-cols-2 gap-4 mb-4 text-gray-300">
          <div>
            <span class="text-gray-500">üìÖ Data:</span> ${dataFormatada}
          </div>
          <div>
            <span class="text-gray-500">‚è∞ Hora:</span> ${a.hora}
          </div>
          <div>
            <span class="text-gray-500">üíá Barbeiro:</span> ${barbeiro.nome || 'N√£o informado'}
          </div>
          <div>
            <span class="text-gray-500">üí∞ Valor:</span> R$ ${parseFloat(servico.preco || 0).toFixed(2)}
          </div>
        </div>
        
        ${a.status !== 'cancelado' && a.status !== 'concluido' ? `
        <div class="flex gap-3">
          <button onclick="editarAgendamento('${a.id}')" 
            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Editar
          </button>
          <button onclick="cancelarAgendamento('${a.id}')" 
            class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-semibold">
            Cancelar
          </button>
        </div>
        ` : ''}
      </div>
    `
  })
}

// Fun√ß√µes globais para os bot√µes
window.editarAgendamento = async (id) => {
  const { data: agendamento } = await supabase
    .from('agendamentos')
    .select('*')
    .eq('id', id)
    .single()
  
  if (!agendamento) return
  
  agendamentoEditando = id
  formTitle.textContent = 'Editar Agendamento'
  formAgendamento.classList.remove('hidden')
  
  await carregarBarbearias()
  selectBarbearia.value = agendamento.barbearia_id
  await carregarBarbeiros(agendamento.barbearia_id)
  await carregarServicos(agendamento.barbearia_id)
  
  selectBarbeiro.value = agendamento.barbeiro_id
  selectServico.value = agendamento.servico_id
  inputData.value = agendamento.data
  inputHora.value = agendamento.hora
  
  window.scrollTo({ top: 0, behavior: 'smooth' })
}

window.cancelarAgendamento = async (id) => {
  if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return
  
  const { error } = await supabase
    .from('agendamentos')
    .update({ status: 'cancelado' })
    .eq('id', id)
  
  if (error) {
    alert('Erro ao cancelar agendamento: ' + error.message)
    return
  }
  
  alert('Agendamento cancelado com sucesso!')
  carregarAgendamentos()
}

// Event listeners
selectBarbearia.addEventListener('change', async (e) => {
  await carregarBarbeiros(e.target.value)
  await carregarServicos(e.target.value)
})

btnNovoAgendamento.addEventListener('click', async () => {
  agendamentoEditando = null
  formTitle.textContent = 'Novo Agendamento'
  formAgendamento.classList.remove('hidden')
  
  selectBarbearia.value = ''
  selectBarbeiro.value = ''
  selectServico.value = ''
  inputData.value = ''
  inputHora.value = ''
  
  await carregarBarbearias()
  selectBarbeiro.disabled = true
  selectServico.disabled = true
  
  window.scrollTo({ top: 0, behavior: 'smooth' })
})

btnCancelarForm.addEventListener('click', () => {
  formAgendamento.classList.add('hidden')
  agendamentoEditando = null
})

btnSalvarAgendamento.addEventListener('click', async () => {
  if (!selectBarbearia.value || !selectBarbeiro.value || !selectServico.value || !inputData.value || !inputHora.value) {
    alert('Preencha todos os campos!')
    return
  }
  
  const dados = {
    barbearia_id: selectBarbearia.value,
    barbeiro_id: selectBarbeiro.value,
    servico_id: selectServico.value,
    data: inputData.value,
    hora: inputHora.value,
    status: 'pendente'
  }
  
  let error
  
  if (agendamentoEditando) {
    const { error: updateError } = await supabase
      .from('agendamentos')
      .update(dados)
      .eq('id', agendamentoEditando)
    error = updateError
  } else {
    dados.cliente_id = userData.user.id
    const { error: insertError } = await supabase
      .from('agendamentos')
      .insert(dados)
    error = insertError
  }
  
  if (error) {
    alert('Erro ao salvar agendamento: ' + error.message)
    return
  }
  
  alert(agendamentoEditando ? 'Agendamento atualizado com sucesso!' : 'Agendamento criado com sucesso!')
  formAgendamento.classList.add('hidden')
  agendamentoEditando = null
  carregarAgendamentos()
})

btnLogout.addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

// Inicializar
await carregarAgendamentos()

</script>

</body>
</html>
