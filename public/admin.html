<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Admin | AgendaBarber</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen">

<!-- HEADER -->
<header class="bg-slate-900 border-b border-slate-800 px-8 py-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">
    Agenda<span class="text-green-500">Barber</span>
  </h1>
  <div class="flex gap-4 items-center">
    <span id="userName" class="text-gray-300"></span>
    <span id="barbeariaName" class="text-gray-400 text-sm"></span>
    <button id="btnLogout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-semibold">Sair</button>
  </div>
</header>

<!-- CONTE√öDO -->
<div class="max-w-7xl mx-auto px-6 py-8">
  <div id="dashboardPrincipal">
    <h2 class="text-3xl font-bold mb-6">Dashboard da Barbearia</h2>
    <!-- ESTAT√çSTICAS -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
        <div id="statAgendamentos" class="text-3xl font-bold text-green-400">0</div>
        <div class="text-sm text-gray-400 mt-1">Agendamentos Hoje</div>
      </div>
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
        <div id="statBarbeiros" class="text-3xl font-bold text-blue-400">0</div>
        <div class="text-sm text-gray-400 mt-1">Barbeiros</div>
      </div>
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
        <div id="statServicos" class="text-3xl font-bold text-purple-400">0</div>
        <div class="text-sm text-gray-400 mt-1">Servi√ßos</div>
      </div>
      <div class="bg-slate-900 p-6 rounded-xl border border-slate-800">
        <div id="statPendentes" class="text-3xl font-bold text-yellow-400">0</div>
        <div class="text-sm text-gray-400 mt-1">Pendentes</div>
      </div>
    </div>
    <!-- TABS -->
    <div class="border-b border-slate-800 mb-6">
      <div class="flex gap-4">
        <button id="tabAgendamentos" class="tab-btn px-4 py-2 border-b-2 border-green-500 font-semibold">Agendamentos</button>
        <button id="tabServicos" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-slate-700 font-semibold">Servi√ßos</button>
        <button id="tabBarbeiros" class="tab-btn px-4 py-2 border-b-2 border-transparent hover:border-slate-700 font-semibold">Barbeiros</button>
      </div>
    </div>
    <!-- CONTE√öDOS -->
    <div id="conteudoAgendamentos">
      <button id="btnNovoAgendamento" class="mb-4 bg-green-500 hover:bg-green-600 text-black px-4 py-2 rounded font-semibold">+ Novo Agendamento</button>
      <div id="formNovoAgendamento" class="hidden bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6">
        <h3 class="text-xl mb-4">Novo Agendamento</h3>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm mb-1">Cliente</label>
            <select id="agendamentoCliente" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Barbeiro</label>
            <select id="agendamentoBarbeiro" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
              <option value="">Selecione um barbeiro</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Servi√ßo</label>
            <select id="agendamentoServico" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
              <option value="">Selecione um servi√ßo</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Data</label>
            <input id="agendamentoData" type="date" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
          </div>
          <div>
            <label class="block text-sm mb-1">Hora</label>
            <input id="agendamentoHora" type="time" class="w-full p-2 rounded bg-slate-800 border border-slate-700">
          </div>
        </div>
        <button id="salvarAgendamento" class="bg-green-500 px-4 py-2 rounded font-medium text-black">Salvar</button>
        <button id="cancelarAgendamento" class="ml-2 bg-gray-600 py-2 px-4 rounded">Cancelar</button>
      </div>
      <div id="listaAgendamentos"></div>
    </div>
    <div id="conteudoServicos" class="hidden">
      <button id="btnNovoServico" class="mb-4 bg-green-500 hover:bg-green-600 text-black px-4 py-2 rounded font-semibold">+ Novo Servi√ßo</button>
      <div id="formNovoServico" class="hidden bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6">
        <h3 class="text-xl mb-4">Novo Servi√ßo</h3>
        <input id="servicoNome" type="text" placeholder="Nome do servi√ßo" class="w-full p-2 mb-2 rounded bg-slate-800">
        <input id="servicoDuracao" type="number" placeholder="Dura√ß√£o (min)" class="w-full p-2 mb-2 rounded bg-slate-800">
        <input id="servicoPreco" type="number" placeholder="Pre√ßo" class="w-full p-2 mb-2 rounded bg-slate-800">
        <button id="salvarServico" class="bg-green-500 px-4 py-2 rounded font-medium text-black">Salvar</button>
        <button id="cancelarServico" class="ml-2 bg-gray-600 py-2 px-4 rounded">Cancelar</button>
      </div>
      <div id="listaServicos"></div>
    </div>
    <div id="conteudoBarbeiros" class="hidden">
      <button id="btnNovoBarbeiro" class="mb-4 bg-green-500 hover:bg-green-600 text-black px-4 py-2 rounded font-semibold">+ Novo Barbeiro</button>
      <div id="formNovoBarbeiro" class="hidden bg-slate-900 p-6 rounded-xl border border-slate-700 mb-6">
        <h3 class="text-xl mb-4">Novo Barbeiro</h3>
        <input id="barbeiroNome" type="text" placeholder="Nome do barbeiro" class="w-full p-2 mb-2 rounded bg-slate-800">
        <input id="barbeiroEmail" type="email" placeholder="Email do barbeiro" class="w-full p-2 mb-2 rounded bg-slate-800">
        <label id="barbeiroSenhaLabel" class="block text-sm mb-1">Senha provis√≥ria</label>
        <input id="barbeiroSenha" type="password" placeholder="Senha provis√≥ria" class="w-full p-2 mb-2 rounded bg-slate-800">
        <button id="salvarBarbeiro" class="bg-green-500 px-4 py-2 rounded font-medium text-black">Salvar</button>
        <button id="cancelarBarbeiro" class="ml-2 bg-gray-600 py-2 px-4 rounded">Cancelar</button>
      </div>
      <div id="listaBarbeiros"></div>
    </div>
  </div>
</div>
<script type="module">
import { supabase } from './js/supabase.js'
import { getCurrentUser, register } from './js/auth.js'

let usuarioAtual = null
let barbearia = null
let barbeiroEditando = null
let servicoEditando = null
let agendamentoEditando = null

// Carregar dados iniciais
async function carregarDados() {
  try {
    usuarioAtual = await getCurrentUser()
    if (!usuarioAtual) {
      window.location.href = 'router.html'
      return
    }

    // Buscar perfil e barbearia
    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', usuarioAtual.id)
      .single()

    if (!profile || profile.role !== 'admin') {
      alert('Acesso negado')
      window.location.href = 'router.html'
      return
    }

    const { data: barbe } = await supabase
      .from('barbearias')
      .select('*')
      .eq('id', profile.barbearia_id)
      .single()

    barbearia = barbe
    console.log('Barbearia carregada:', barbearia)
    
    document.getElementById('userName').textContent = profile.nome
    document.getElementById('barbeariaName').textContent = '(' + barbe.nome + ')'

    // Aguardar cada carregamento em sequ√™ncia
    await carregarBarbeiros()
    await carregarServicos()
    await carregarAgendamentos()
    
    console.log('Todos os dados carregados com sucesso')
  } catch (error) {
    console.error('Erro ao carregar dados:', error)
    alert('Erro ao carregar dados: ' + error.message)
  }
}

// ===== BARBEIROS =====
async function carregarBarbeiros() {
  try {
    if (!barbearia || !barbearia.id) {
      console.error('Barbearia n√£o carregada ainda')
      return
    }

    console.log('Iniciando carregarBarbeiros com barbearia.id:', barbearia.id)
    
    const { data: barbeiros, error } = await supabase
      .from('profiles')
      .select('id, nome, role, barbearia_id')
      .eq('barbearia_id', barbearia.id)
      .order('nome')

    console.log('carregarBarbeiros -> fetched', { barbearia_id: barbearia.id, barbeiros, error, barbeirosCount: barbeiros?.length })

    if (error) {
      console.error('Erro ao carregar barbeiros:', error)
      document.getElementById('listaBarbeiros').innerHTML = '<p class="text-red-400">Erro ao carregar barbeiros: ' + error.message + '</p>'
      return
    }

    document.getElementById('statBarbeiros').textContent = barbeiros?.length || 0
    
    let html = '<div class="grid gap-3">'
    if (barbeiros && barbeiros.length > 0) {
      console.log('Renderizando', barbeiros.length, 'barbeiros')
      for (const barb of barbeiros) {
        console.log('Adicionando barbeiro:', barb.nome)
        html += `
          <div class="bg-slate-900 p-4 rounded border border-slate-700 flex justify-between items-center">
            <div>
              <div class="font-semibold">${barb.nome}</div>
              <div class="text-xs text-gray-400">ID Barbearia: ${barb.barbearia_id ? barb.barbearia_id.substring(0, 8) : 'N/A'}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editarBarbeiro('${barb.id}')" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">Editar</button>
              <button onclick="deletarBarbeiro('${barb.id}')" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Deletar</button>
            </div>
          </div>
        `
      }
    } else {
      console.log('Nenhum barbeiro encontrado')
      html += '<p class="text-gray-400">Nenhum barbeiro cadastrado</p>'
    }
    html += '</div>'
    
    console.log('Definindo innerHTML de listaBarbeiros com', html.length, 'caracteres')
    const elemento = document.getElementById('listaBarbeiros')
    console.log('Elemento encontrado?', elemento ? 'SIM' : 'N√ÉO')
    
    if (elemento) {
      elemento.innerHTML = html
      console.log('HTML atualizado com sucesso')
    } else {
      console.error('Elemento listaBarbeiros n√£o encontrado na DOM!')
    }
  } catch (error) {
    console.error('Erro na fun√ß√£o carregarBarbeiros:', error)
  }
}

async function salvarBarbeiro() {
  const nome = document.getElementById('barbeiroNome').value.trim()
  const email = document.getElementById('barbeiroEmail').value.trim()
  const senha = document.getElementById('barbeiroSenha').value

  if (!nome || !email) {
    alert('Preencha nome e email')
    return
  }

  if (!barbearia || !barbearia.id) {
    alert('Barbearia n√£o carregada. Recarregue a p√°gina.')
    return
  }

  try {
    if (barbeiroEditando) {
      // Editar apenas nome
      const { error } = await supabase
        .from('profiles')
        .update({ nome })
        .eq('id', barbeiroEditando)

      if (error) throw error
      alert('Barbeiro atualizado com sucesso!')
    } else {
      // Criar novo barbeiro
      if (!senha) {
        alert('Informe uma senha para o novo barbeiro')
        return
      }

      console.log('Registrando barbeiro com dados:', {
        nome,
        email,
        role: 'barbeiro',
        barbearia_id: barbearia.id
      })

      const { error } = await register(email, senha, {
        nome,
        role: 'barbeiro',
        barbearia_id: barbearia.id
      })

      if (error) {
        console.error('Erro ao registrar:', error)
        throw error
      }

      // Aguarda um pouco para garantir que o trigger criou o profile
      await new Promise(resolve => setTimeout(resolve, 1000))

      alert('Barbeiro cadastrado com sucesso!')
    }

    document.getElementById('formNovoBarbeiro').classList.add('hidden')
    document.getElementById('barbeiroNome').value = ''
    document.getElementById('barbeiroEmail').value = ''
    document.getElementById('barbeiroSenha').value = ''
    barbeiroEditando = null
    await carregarBarbeiros()
  } catch (error) {
    console.error('Erro:', error)
    alert('Erro: ' + (error.message || 'Verifique o console'))
  }
}

window.editarBarbeiro = async (id) => {
  const { data: barb } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', id)
    .single()

  barbeiroEditando = id
  document.getElementById('barbeiroNome').value = barb.nome || ''
  document.getElementById('barbeiroEmail').value = '(N√£o edit√°vel)'
  document.getElementById('barbeiroEmail').disabled = true
  document.getElementById('barbeiroSenha').style.display = 'none'
  document.getElementById('barbeiroSenhaLabel').style.display = 'none'
  document.getElementById('formNovoBarbeiro').classList.remove('hidden')
}

window.deletarBarbeiro = async (id) => {
  if (!confirm('Tem certeza que deseja deletar este barbeiro?')) return
  
  try {
    // Apenas marca como inativo no profile (n√£o delete para manter hist√≥rico)
    const { error } = await supabase
      .from('profiles')
      .update({ role: 'inativo' })
      .eq('id', id)

    if (error) throw error
    alert('Barbeiro removido com sucesso!')
    carregarBarbeiros()
  } catch (error) {
    alert('Erro: ' + error.message)
  }
}

// ===== SERVI√áOS =====
async function carregarServicos() {
  const { data: servicos } = await supabase
    .from('servicos')
    .select('*')
    .eq('barbearia_id', barbearia.id)
    .order('nome')

  document.getElementById('statServicos').textContent = servicos?.length || 0

  let html = '<div class="grid gap-3">'
  if (servicos && servicos.length > 0) {
    for (const srv of servicos) {
      html += `
        <div class="bg-slate-900 p-4 rounded border border-slate-700">
          <div class="flex justify-between items-start mb-2">
            <div>
              <div class="font-semibold">${srv.nome}</div>
              <div class="text-sm text-gray-400">‚è±Ô∏è ${srv.duracao} min | üí∞ R$ ${srv.preco}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editarServico('${srv.id}')" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">Editar</button>
              <button onclick="deletarServico('${srv.id}')" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Deletar</button>
            </div>
          </div>
        </div>
      `
    }
  } else {
    html += '<p class="text-gray-400">Nenhum servi√ßo cadastrado</p>'
  }
  html += '</div>'
  document.getElementById('listaServicos').innerHTML = html
}

async function salvarServico() {
  const nome = document.getElementById('servicoNome').value.trim()
  const duracao = parseInt(document.getElementById('servicoDuracao').value)
  const preco = parseFloat(document.getElementById('servicoPreco').value)

  if (!nome || !duracao || !preco) {
    alert('Preencha todos os campos corretamente')
    return
  }

  try {
    if (servicoEditando) {
      const { error } = await supabase
        .from('servicos')
        .update({ nome, duracao, preco })
        .eq('id', servicoEditando)

      if (error) throw error
      alert('Servi√ßo atualizado com sucesso!')
    } else {
      const { error } = await supabase
        .from('servicos')
        .insert([{ barbearia_id: barbearia.id, nome, duracao, preco }])

      if (error) throw error
      alert('Servi√ßo criado com sucesso!')
    }

    document.getElementById('formNovoServico').classList.add('hidden')
    document.getElementById('servicoNome').value = ''
    document.getElementById('servicoDuracao').value = ''
    document.getElementById('servicoPreco').value = ''
    servicoEditando = null
    carregarServicos()
  } catch (error) {
    alert('Erro: ' + error.message)
  }
}

window.editarServico = async (id) => {
  const { data: srv } = await supabase
    .from('servicos')
    .select('*')
    .eq('id', id)
    .single()

  servicoEditando = id
  document.getElementById('servicoNome').value = srv.nome
  document.getElementById('servicoDuracao').value = srv.duracao
  document.getElementById('servicoPreco').value = srv.preco
  document.getElementById('formNovoServico').classList.remove('hidden')
}

window.deletarServico = async (id) => {
  if (!confirm('Deletar este servi√ßo?')) return
  
  try {
    const { error } = await supabase
      .from('servicos')
      .delete()
      .eq('id', id)

    if (error) throw error
    carregarServicos()
  } catch (error) {
    alert('Erro: ' + error.message)
  }
}

// ===== AGENDAMENTOS =====
async function carregarAgendamentos() {
  const hoje = new Date().toISOString().split('T')[0]
  const { data: agendamentos } = await supabase
    .from('agendamentos')
    .select('*, servicos(nome, preco), profiles!agendamentos_cliente_id_fkey(nome)')
    .eq('barbearia_id', barbearia.id)
    .gte('data', hoje)
    .order('data', { ascending: true })
    .order('hora', { ascending: true })

  document.getElementById('statAgendamentos').textContent = agendamentos?.length || 0
  document.getElementById('statPendentes').textContent = agendamentos?.filter(a => a.status === 'pendente').length || 0

  let html = '<div class="grid gap-3">'
  if (agendamentos && agendamentos.length > 0) {
    for (const age of agendamentos) {
      const dataFormatada = new Date(age.data).toLocaleDateString('pt-BR')
      const statusCores = {
        pendente: 'yellow',
        confirmado: 'green',
        concluido: 'blue',
        cancelado: 'red'
      }
      const corStatus = statusCores[age.status] || 'gray'

      html += `
        <div class="bg-slate-900 p-4 rounded border border-slate-700">
          <div class="flex justify-between items-start mb-2">
            <div>
              <div class="font-semibold">${age.profiles?.nome || 'Cliente'}</div>
              <div class="text-sm text-gray-400">${age.servicos?.nome || 'Servi√ßo'} | ${dataFormatada} ${age.hora}</div>
            </div>
            <div class="flex gap-2">
              <button onclick="editarAgendamento('${age.id}')" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">Editar</button>
              <button onclick="deletarAgendamento('${age.id}')" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Deletar</button>
            </div>
          </div>
          <span class="text-xs bg-${corStatus}-900 px-2 py-1 rounded">${age.status}</span>
        </div>
      `
    }
  } else {
    html += '<p class="text-gray-400">Nenhum agendamento pr√≥ximo</p>'
  }
  html += '</div>'
  document.getElementById('listaAgendamentos').innerHTML = html
}

async function salvarAgendamento() {
  const clienteId = document.getElementById('agendamentoCliente').value
  const barbeiroId = document.getElementById('agendamentoBarbeiro').value
  const servicoId = document.getElementById('agendamentoServico').value
  const data = document.getElementById('agendamentoData').value
  const hora = document.getElementById('agendamentoHora').value

  if (!clienteId || !barbeiroId || !servicoId || !data || !hora) {
    alert('Preencha todos os campos')
    return
  }

  try {
    const dados = {
      barbearia_id: barbearia.id,
      cliente_id: clienteId,
      barbeiro_id: barbeiroId,
      servico_id: servicoId,
      data,
      hora,
      status: 'pendente'
    }

    if (agendamentoEditando) {
      const { error } = await supabase
        .from('agendamentos')
        .update(dados)
        .eq('id', agendamentoEditando)

      if (error) throw error
      alert('Agendamento atualizado!')
    } else {
      const { error } = await supabase
        .from('agendamentos')
        .insert([dados])

      if (error) throw error
      alert('Agendamento criado!')
    }

    document.getElementById('formNovoAgendamento').classList.add('hidden')
    agendamentoEditando = null
    carregarAgendamentos()
    limparFormAgendamento()
  } catch (error) {
    alert('Erro: ' + error.message)
  }
}

window.editarAgendamento = async (id) => {
  const { data: age } = await supabase
    .from('agendamentos')
    .select('*')
    .eq('id', id)
    .single()

  agendamentoEditando = id
  document.getElementById('agendamentoCliente').value = age.cliente_id
  document.getElementById('agendamentoBarbeiro').value = age.barbeiro_id
  document.getElementById('agendamentoServico').value = age.servico_id
  document.getElementById('agendamentoData').value = age.data
  document.getElementById('agendamentoHora').value = age.hora
  document.getElementById('formNovoAgendamento').classList.remove('hidden')
}

window.deletarAgendamento = async (id) => {
  if (!confirm('Deletar este agendamento?')) return
  
  try {
    const { error } = await supabase
      .from('agendamentos')
      .delete()
      .eq('id', id)

    if (error) throw error
    carregarAgendamentos()
  } catch (error) {
    alert('Erro: ' + error.message)
  }
}

function limparFormAgendamento() {
  document.getElementById('agendamentoCliente').value = ''
  document.getElementById('agendamentoBarbeiro').value = ''
  document.getElementById('agendamentoServico').value = ''
  document.getElementById('agendamentoData').value = ''
  document.getElementById('agendamentoHora').value = ''
}

// ===== TABS =====
document.getElementById('tabAgendamentos').onclick = () => {
  document.getElementById('conteudoAgendamentos').classList.remove('hidden')
  document.getElementById('conteudoServicos').classList.add('hidden')
  document.getElementById('conteudoBarbeiros').classList.add('hidden')
  document.getElementById('tabAgendamentos').classList.add('border-green-500')
  document.getElementById('tabServicos').classList.remove('border-green-500')
  document.getElementById('tabBarbeiros').classList.remove('border-green-500')
}

document.getElementById('tabServicos').onclick = () => {
  document.getElementById('conteudoAgendamentos').classList.add('hidden')
  document.getElementById('conteudoServicos').classList.remove('hidden')
  document.getElementById('conteudoBarbeiros').classList.add('hidden')
  document.getElementById('tabAgendamentos').classList.remove('border-green-500')
  document.getElementById('tabServicos').classList.add('border-green-500')
  document.getElementById('tabBarbeiros').classList.remove('border-green-500')
}

document.getElementById('tabBarbeiros').onclick = () => {
  document.getElementById('conteudoAgendamentos').classList.add('hidden')
  document.getElementById('conteudoServicos').classList.add('hidden')
  document.getElementById('conteudoBarbeiros').classList.remove('hidden')
  document.getElementById('tabAgendamentos').classList.remove('border-green-500')
  document.getElementById('tabServicos').classList.remove('border-green-500')
  document.getElementById('tabBarbeiros').classList.add('border-green-500')
}

// ===== MODAIS =====
document.getElementById('btnNovoAgendamento').onclick = () => {
  agendamentoEditando = null
  limparFormAgendamento()
  carregarClientesBarbeirosServicos()
  document.getElementById('formNovoAgendamento').classList.remove('hidden')
}

document.getElementById('cancelarAgendamento').onclick = () => {
  document.getElementById('formNovoAgendamento').classList.add('hidden')
  agendamentoEditando = null
}

document.getElementById('btnNovoServico').onclick = () => {
  servicoEditando = null
  document.getElementById('servicoNome').value = ''
  document.getElementById('servicoDuracao').value = ''
  document.getElementById('servicoPreco').value = ''
  document.getElementById('barbeiroEmail').disabled = false
  document.getElementById('barbeiroSenha').style.display = 'block'
  document.getElementById('barbeiroSenhaLabel').style.display = 'block'
  document.getElementById('formNovoServico').classList.remove('hidden')
}

document.getElementById('cancelarServico').onclick = () => {
  document.getElementById('formNovoServico').classList.add('hidden')
  servicoEditando = null
}

document.getElementById('btnNovoBarbeiro').onclick = () => {
  barbeiroEditando = null
  document.getElementById('barbeiroNome').value = ''
  document.getElementById('barbeiroEmail').value = ''
  document.getElementById('barbeiroSenha').value = ''
  document.getElementById('barbeiroEmail').disabled = false
  document.getElementById('barbeiroSenha').style.display = 'block'
  document.getElementById('barbeiroSenhaLabel').style.display = 'block'
  document.getElementById('formNovoBarbeiro').classList.remove('hidden')
}

document.getElementById('cancelarBarbeiro').onclick = () => {
  document.getElementById('formNovoBarbeiro').classList.add('hidden')
  barbeiroEditando = null
}

document.getElementById('salvarServico').onclick = salvarServico
document.getElementById('salvarBarbeiro').onclick = salvarBarbeiro
document.getElementById('salvarAgendamento').onclick = salvarAgendamento

async function carregarClientesBarbeirosServicos() {
  // Clientes
  const { data: clientes } = await supabase
    .from('profiles')
    .select('id, nome')
    .eq('role', 'cliente')
    .order('nome')
  
  let html = '<option value="">Selecione um cliente</option>'
  clientes?.forEach(c => {
    html += `<option value="${c.id}">${c.nome}</option>`
  })
  document.getElementById('agendamentoCliente').innerHTML = html

  // Barbeiros
  const { data: barbeiros } = await supabase
    .from('profiles')
    .select('id, nome')
    .eq('barbearia_id', barbearia.id)
    .eq('role', 'barbeiro')
    .order('nome')
  
  html = '<option value="">Selecione um barbeiro</option>'
  barbeiros?.forEach(b => {
    html += `<option value="${b.id}">${b.nome}</option>`
  })
  document.getElementById('agendamentoBarbeiro').innerHTML = html

  // Servi√ßos
  const { data: servicos } = await supabase
    .from('servicos')
    .select('id, nome, preco')
    .eq('barbearia_id', barbearia.id)
    .order('nome')
  
  html = '<option value="">Selecione um servi√ßo</option>'
  servicos?.forEach(s => {
    html += `<option value="${s.id}">${s.nome} (R$ ${s.preco})</option>`
  })
  document.getElementById('agendamentoServico').innerHTML = html

  // Data m√≠nima = hoje
  const hoje = new Date().toISOString().split('T')[0]
  document.getElementById('agendamentoData').min = hoje
}

document.getElementById('btnLogout').onclick = async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
}

// Carregar dados ao iniciar
carregarDados()
</script>
</body>
</html>